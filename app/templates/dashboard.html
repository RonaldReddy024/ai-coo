<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>WorkYodha AI COO – Sprint Risk Dashboard</title>
    <style>
        body {
            margin: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: #0f172a;
            color: #e5e7eb;
        }

        .layout {
            display: grid;
            grid-template-columns: 2fr 1.3fr;
            min-height: 100vh;
        }

        .panel {
            padding: 24px;
            box-sizing: border-box;
        }

        .panel-left {
            border-right: 1px solid #1f2937;
        }

        h1 {
            margin: 0 0 12px;
            font-size: 24px;
            font-weight: 600;
        }

        h2 {
            margin: 24px 0 8px;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: #9ca3af;
        }

        .subtitle {
            color: #9ca3af;
            font-size: 14px;
            margin-bottom: 16px;
        }

        /* Top bar: filters + button */
        .top-bar {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .select-wrapper {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .select-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: #9ca3af;
        }

        .filter-select {
            padding: 6px 8px;
            border-radius: 999px;
            border: 1px solid #374151;
            background: #020617;
            color: #e5e7eb;
            font-size: 13px;
            outline: none;
        }

        .filter-select:focus {
            border-color: #6366f1;
        }

        .button-primary {
            padding: 8px 14px;
            border-radius: 999px;
            border: none;
            font-size: 13px;
            font-weight: 600;
            background: #6366f1;
            color: white;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .button-primary:hover {
            background: #4f46e5;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 8px;
        }

        th, td {
            padding: 10px 12px;
            text-align: left;
            font-size: 14px;
        }

        th {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: #9ca3af;
            border-bottom: 1px solid #1f2937;
        }

        tr {
            cursor: pointer;
            transition: background 0.15s ease;
        }

        tr:nth-child(even) {
            background: #020617;
        }

        tr:hover {
            background: #111827;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 11px;
            font-weight: 600;
        }

        .badge-low {
            background: rgba(34, 197, 94, 0.1);
            color: #22c55e;
        }

        .badge-medium {
            background: rgba(234, 179, 8, 0.1);
            color: #eab308;
        }

        .badge-high {
            background: rgba(239, 68, 68, 0.1);
            color: #f97373;
        }

        .pill {
            display: inline-flex;
            align-items: center;
            padding: 6px 10px;
            border-radius: 999px;
            background: #020617;
            border: 1px solid #1f2937;
            font-size: 11px;
            color: #9ca3af;
            margin-right: 8px;
        }

        .pill span {
            font-weight: 600;
            color: #e5e7eb;
            margin-left: 4px;
        }

        .card {
            border-radius: 16px;
            background: #020617;
            border: 1px solid #1f2937;
            padding: 16px 18px;
            box-sizing: border-box;
        }

        .risk-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .risk-score {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .risk-explanation {
            font-size: 14px;
            line-height: 1.6;
            color: #d1d5db;
            white-space: pre-wrap;
        }

        .muted {
            font-size: 12px;
            color: #6b7280;
            margin-top: 8px;
        }

        .empty-state {
            padding: 24px;
            text-align: center;
            border-radius: 16px;
            background: #020617;
            border: 1px dashed #374151;
            color: #9ca3af;
            font-size: 14px;
        }

        .selected-row {
            outline: 1px solid #6366f1;
            outline-offset: -1px;
        }

        .risk-panel {
            border-radius: 16px;
            background: #020617;
            border: 1px solid #1f2937;
            padding: 16px 18px;
            box-sizing: border-box;
        }

        .issues-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 12px;
            margin-bottom: 8px;
        }

        .small-btn {
            padding: 6px 10px;
            border-radius: 10px;
            border: 1px solid #374151;
            background: #111827;
            color: #e5e7eb;
            font-size: 12px;
            cursor: pointer;
        }

        .small-btn:hover {
            background: #1f2937;
        }

        .issues-list {
            border: 1px solid #1f2937;
            border-radius: 12px;
            padding: 10px;
            background: #0b1224;
        }

        .issue-item {
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 4px;
            margin-bottom: 6px;
            background: #f7f7f7;
            transition: background 0.2s;
        }

        .issue-item:hover {
            background: #ececec;
        }

        .issue-row {
            padding: 8px 10px;
            border-bottom: 1px solid #1f2937;
        }

        .issue-row:last-child {
            border-bottom: none;
        }

        .issue-title {
            font-weight: 600;
        }

        .issue-meta {
            color: #9ca3af;
            font-size: 12px;
        }

        .checkbox-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 8px 0;
        }

        /* Modal */

        .modal {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }

        .modal.hidden {
            display: none;
        }

        .modal-content {
            width: 100%;
            max-width: 420px;
            background: #020617;
            border-radius: 16px;
            border: 1px solid #1f2937;
            padding: 20px 22px;
            box-sizing: border-box;
        }

        .modal-content label {
            display: block;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: #9ca3af;
            margin-bottom: 4px;
        }

        .modal-content input,
        .modal-content select {
            width: 100%;
            padding: 8px 10px;
            border-radius: 10px;
            border: 1px solid #374151;
            background: #020617;
            color: #e5e7eb;
            font-size: 13px;
            box-sizing: border-box;
            margin-bottom: 12px;
        }

        .modal-content input:focus,
        .modal-content select:focus {
            outline: none;
            border-color: #6366f1;
        }

        .form-actions {
        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 8px;
        }

        .button-secondary {
            padding: 8px 12px;
            border-radius: 999px;
            border: 1px solid #374151;
            background: #020617;
            color: #e5e7eb;
            font-size: 13px;
            cursor: pointer;
        }

        .button-secondary:hover {
            background: #111827;
        }

        .sprint-row {
            padding: 12px 14px;
            border: 1px solid #1f2937;
            border-radius: 12px;
            background: #020617;
            margin-bottom: 10px;
            cursor: pointer;
            transition: background 0.15s ease, border-color 0.15s ease;
        }

        .sprint-row:hover {
            background: #111827;
            border-color: #374151;
        }
    </style>
</head>
<body>
<div class="layout">
    <!-- LEFT: Sprint list + filters -->
    <div class="panel panel-left">
        <h1>WorkYodha AI COO – Sprint Risks</h1>
        <div class="subtitle">
            Monitor sprint health across projects. Use filters to focus on a company or project, then click a sprint to see a detailed AI risk explanation powered by WorkYodha.
        </div>

        <div class="top-bar">
            <div class="select-wrapper">
                <span class="select-label">Company</span>
                <select id="company-filter" class="filter-select">
                    <option value="">All companies</option>
                </select>
            </div>
            <div class="select-wrapper">
                <span class="select-label">Project</span>
                <select id="project-filter" class="filter-select">
                    <option value="">All projects</option>
                </select>
            </div>
            <button class="button-primary" id="create-sprint-btn">
                + Create sprint
            </button>
        </div>

        <h2>Sprints</h2>
        <div id="sprint-list" aria-live="polite"></div>
    </div>

    <!-- RIGHT: Risk details -->
    <div class="panel">
        <div class="risk-panel">
          <h2 id="risk-title">Select a sprint to see details</h2>
          <p id="risk-text">
            This panel shows a natural-language explanation of why a sprint
            is considered low, medium, or high risk.
          </p>

          <hr />

          <div id="issues-section">
            <div class="issues-header">
              <h3>Issues</h3>
              <button id="add-issue-btn" class="small-btn">+ Add issue</button>
            </div>
            <div id="issues-list" class="issues-list">
              <p class="empty-state">No sprint selected.</p>
            </div>
          </div>
        </div>
    </div>
</div>

<!-- Create Sprint Modal -->
<div id="create-sprint-modal" class="modal hidden">
  <div class="modal-content">
    <h2>Create new sprint</h2>

    <!-- PROJECT -->
    <label for="modal-project-select">Project</label>
    <select id="modal-project-select">
      <option value="">Select a project</option>
    </select>

    <!-- NAME -->
    <label for="modal-sprint-name">Sprint name</label>
    <input id="modal-sprint-name" type="text" placeholder="e.g. Sprint 12 – Checkout revamp">

    <!-- START DATE -->
    <label for="modal-start-date">Start date</label>
    <input id="modal-start-date" type="date">

    <!-- END DATE -->
    <label for="modal-end-date">End date</label>
    <input id="modal-end-date" type="date">

    <div class="modal-actions">
      <button id="modal-cancel-btn" class="button-secondary">Cancel</button>
      <button id="modal-create-btn" class="button-primary">Create sprint</button>
    </div>
  </div>
</div>

<!-- Create Issue Modal -->
<div id="create-issue-modal" class="modal hidden">
  <div class="modal-content">
    <h2>Create new issue</h2>

    <label for="issue-title">Title</label>
    <input id="issue-title" type="text" placeholder="e.g. Fix DB migration bug" />

    <label for="issue-status">Status</label>
    <select id="issue-status">
      <option value="To Do">To Do</option>
      <option value="In Progress">In Progress</option>
      <option value="Review">Review</option>
      <option value="Done">Done</option>
    </select>

    <label for="issue-assignee">Assignee</label>
    <input id="issue-assignee" type="text" placeholder="e.g. Ronald" />

    <label class="checkbox-row">
      <input id="issue-blocker" type="checkbox" />
      <span>Is blocker?</span>
    </label>

    <div class="modal-actions">
      <button id="issue-cancel-btn">Cancel</button>
      <button id="issue-create-btn">Create issue</button>
    </div>
  </div>
</div>

<script>
  const companyFilter = document.getElementById("company-filter");
  const projectFilter = document.getElementById("project-filter");
  const sprintList = document.getElementById("sprint-list");

  const createSprintBtn = document.getElementById("create-sprint-btn");
  const modal = document.getElementById("create-sprint-modal");
  const modalProjectSelect = document.getElementById("modal-project-select");
  const modalSprintName = document.getElementById("modal-sprint-name");
  const modalStartDate = document.getElementById("modal-start-date");
  const modalEndDate = document.getElementById("modal-end-date");
  const modalCancelBtn = document.getElementById("modal-cancel-btn");
  const modalCreateBtn = document.getElementById("modal-create-btn");

  let currentSprintId = null;

  const issuesList = document.getElementById("issues-list");
  const addIssueBtn = document.getElementById("add-issue-btn");

  const issueModal = document.getElementById("create-issue-modal");
  const issueTitleInput = document.getElementById("issue-title");
  const issueStatusSelect = document.getElementById("issue-status");
  const issueAssigneeInput = document.getElementById("issue-assignee");
  const issueBlockerCheckbox = document.getElementById("issue-blocker");
  const issueCancelBtn = document.getElementById("issue-cancel-btn");
  const issueCreateBtn = document.getElementById("issue-create-btn");

  // ====== LOAD COMPANIES & PROJECTS ======

  async function loadCompanies() {
    const res = await fetch("/companies");
    const companies = await res.json();

    companyFilter.innerHTML = '<option value="">All companies</option>';
    companies.forEach(c => {
      const opt = document.createElement("option");
      opt.value = c.id;
      opt.textContent = c.name;
      companyFilter.appendChild(opt);
    });
  }

  async function loadProjectsForCompany(companyId) {
    if (!companyId) {
      projectFilter.innerHTML = '<option value="">All projects</option>';
      modalProjectSelect.innerHTML = '<option value="">Select a project</option>';
      return;
    }

    const res = await fetch(`/companies/${companyId}/projects`);
    const projects = await res.json();

    projectFilter.innerHTML = '<option value="">All projects</option>';
    projects.forEach(p => {
      const opt = document.createElement("option");
      opt.value = p.id;
      opt.textContent = p.name;
      projectFilter.appendChild(opt);
    });

    modalProjectSelect.innerHTML = '<option value="">Select a project</option>';
    projects.forEach(p => {
      const opt = document.createElement("option");
      opt.value = p.id;
      opt.textContent = p.name;
      modalProjectSelect.appendChild(opt);
    });
  }

  // ====== LOAD SPRINTS FOR CURRENT FILTERS ======

  async function loadSprints() {
    const companyId = companyFilter.value;
    const projectId = projectFilter.value;

    let url = "/sprints";
    const params = [];
    if (companyId) params.push(`company_id=${companyId}`);
    if (projectId) params.push(`project_id=${projectId}`);
    if (params.length) url += "?" + params.join("&");

    const res = await fetch(url);
    const sprints = await res.json();

    sprintList.innerHTML = "";
    if (!sprints.length) {
      sprintList.innerHTML = "<div class='empty-state'>No sprints found</div>";
      return;
    }

    sprints.forEach(s => {
      const row = document.createElement("div");
      row.className = "sprint-row";
      row.textContent = s.name;
      row.addEventListener("click", () => selectSprint(s.id));
      sprintList.appendChild(row);
    });
  }

  async function selectSprint(sprintId) {
    currentSprintId = sprintId;

    // 1) Get full sprint (including issues) for list rendering
    const sprintRes = await fetch(`/sprints/${sprintId}`);
    const sprint = await sprintRes.json();

    // 2) Get AI-style risk explanation
    const riskRes = await fetch(`/sprints/${sprintId}/risk`);
    if (!sprintRes.ok) {
      console.error("Failed to fetch sprint", await sprintRes.text());
      alert("Failed to load sprint details.");
      return;
    }
    const risk = await riskRes.json();

    // Update title + text from risk API
    const reportTitle = document.getElementById("risk-title");
    const reportText = document.getElementById("risk-text");

    reportTitle.textContent = `${risk.summary}`;
    reportText.textContent = risk.details;

    // Render issues under the sprint (from /sprints/{id})

    renderIssues(sprint.issues);
  }

  function renderIssues(issues) {
    const issuesList = document.getElementById("issues-list");
    issuesList.innerHTML = "";

    if (!issues || issues.length === 0) {
        issuesList.innerHTML = "<p style='color:#555;'>No issues yet for this sprint.</p>";
        return;
    }

    issues.forEach((issue) => {
        const div = document.createElement("div");
        div.className = "issue-item";

        div.innerHTML = `
            <strong>${issue.key}</strong> – ${issue.title}<br>
            <small>Status: ${issue.status}</small>
        `;

        // CLICK HANDLER FOR EACH ISSUE
        div.onclick = () => {
            selectIssue(issue.id);
        };

        issuesList.appendChild(div);
    });
  }

  function selectIssue(issueId) {
    alert("Clicked issue " + issueId);
  }

  // ====== ISSUE MODAL HANDLERS ======

  addIssueBtn.addEventListener("click", () => {
    if (!currentSprintId) {
      alert("Please select a sprint first.");
      return;
    }
    issueModal.classList.remove("hidden");
  });

  issueCancelBtn.addEventListener("click", () => {
    issueModal.classList.add("hidden");
  });

  issueCreateBtn.addEventListener("click", async () => {
    if (!currentSprintId) {
      alert("No sprint selected.");
      return;
    }

    const title = issueTitleInput.value.trim();
    const status = issueStatusSelect.value;
    const assignee = issueAssigneeInput.value.trim();
    const is_blocker = issueBlockerCheckbox.checked;

    if (!title) {
      alert("Please enter a title.");
      return;
    }

    const payload = {
      title,
      status,
      assignee: assignee || null,
      is_blocker
    };

    const res = await fetch(`/sprints/${currentSprintId}/issues`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    });

    if (!res.ok) {
      const err = await res.json();
      console.error("Failed to create issue:", err);
      alert("Failed to create issue.");
      return;
    }

    issueModal.classList.add("hidden");
    issueTitleInput.value = "";
    issueAssigneeInput.value = "";
    issueBlockerCheckbox.checked = false;

    await selectSprint(currentSprintId);
  });

  // ====== CREATE SPRINT MODAL ======

  createSprintBtn.addEventListener("click", () => {
    const companyId = companyFilter.value;
    if (!companyId) {
      alert("Please select a company first.");
      return;
    }

    loadProjectsForCompany(companyId);
    modal.classList.remove("hidden");
  });

  modalCancelBtn.addEventListener("click", () => {
    modal.classList.add("hidden");
  });

  modalCreateBtn.addEventListener("click", async () => {
    const projectId = parseInt(modalProjectSelect.value, 10);
    const name = modalSprintName.value.trim();
    const startDate = modalStartDate.value;
    const endDate = modalEndDate.value;

    if (!projectId) {
      alert("Please select a project.");
      return;
    }

    if (!name) {
      alert("Please enter a sprint name.");
      return;
    }

    const payload = {
      name: name,
      project_id: projectId,
      start_date: startDate ? new Date(startDate).toISOString() : undefined,
      end_date: endDate ? new Date(endDate).toISOString() : undefined
    };
      
    const res = await fetch("/sprints/", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    if (!res.ok) {
      const err = await res.json();
      console.error("Error creating sprint:", err);
      alert("Failed to create sprint. Check console for details.");
      return;
    }

    modal.classList.add("hidden");
    modalSprintName.value = "";
    modalStartDate.value = "";
    modalEndDate.value = "";

    await loadSprints();
  });

  // ====== FILTER CHANGE HANDLERS ======

  companyFilter.addEventListener("change", async (e) => {
    const companyId = e.target.value;
    await loadProjectsForCompany(companyId);
    await loadSprints();
  });

  projectFilter.addEventListener("change", loadSprints);

  // ====== INITIALISE DASHBOARD ======
  (async function init() {
    await loadCompanies();
    await loadSprints();
  })();
</script>
</body>
</html>

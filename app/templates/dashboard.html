<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>WorkYodha AI COO – Sprint Risks</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      margin: 0;
      padding: 20px;
      background: #020617;
      color: #e5e7eb;
    }
    h1 { margin: 0 0 4px 0; }
    p.sub { margin: 0 0 16px 0; color: #9ca3af; font-size: 14px; }

    .layout-top {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 16px;
      flex-wrap: wrap;
    }
    .pill {
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 999px;
      background: #111827;
      color: #9ca3af;
    }

    .filters {
      margin-top: 16px;
      margin-bottom: 8px;
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
      font-size: 13px;
    }
    .filters label {
      display: flex;
      flex-direction: column;
      gap: 4px;
      color: #9ca3af;
      font-size: 12px;
    }
    .filters select,
    .filters input {
      background: #020617;
      border: 1px solid #1f2937;
      border-radius: 999px;
      padding: 6px 10px;
      color: #e5e7eb;
      font-size: 13px;
      outline: none;
    }
    .filters button {
      border-radius: 999px;
      border: none;
      padding: 7px 14px;
      font-size: 13px;
      cursor: pointer;
      background: #2563eb;
      color: #e5e7eb;
    }
    .filters button:hover {
      background: #1d4ed8;
    }

    .refresh-indicator {
      font-size: 12px;
      color: #6b7280;
      margin-left: auto;
    }

    .summary-strip {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
      font-size: 0.95rem;
    }

    .summary-strip span {
      white-space: nowrap;
    }

    .toggle-fallback-btn {
      margin-left: auto;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid #ddd;
      background: #f8f8f8;
      cursor: pointer;
      font-size: 0.85rem;
    }

    .toggle-fallback-btn:hover {
      background: #eee;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
      font-size: 13px;
    }
    th, td {
      padding: 8px 10px;
      border-bottom: 1px solid #111827;
      text-align: left;
      vertical-align: top;
    }
    th {
      background: #020617;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    .badge {
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }
    .status-completed { background: #16a34a22; color: #4ade80; }
    .status-pending   { background: #fbbf2422; color: #facc15; }
    .status-running   { background: #38bdf822; color: #7dd3fc; }

    .meta {
      color: #9ca3af;
      font-size: 12px;
      margin-top: 2px;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .status-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      display: inline-block;
      margin-right: 4px;
      background: #4ade80;
    }
  </style>
</head>
<body>
  <div class="layout-top">
    <div>
      <h1>WorkYodha AI COO – Sprint Risks</h1>
      <p class="sub">
        Live view of tasks your AI COO is processing in rupees (₹).
      </p>
    </div>
    <div>
      <span class="pill">
        <span class="status-dot"></span>
        Backend: healthy
      </span>
    </div>
  </div>

  <div class="filters">
    <label>
      Status
      <select id="filter-status">
        <option value="">All</option>
        <option value="pending">Pending</option>
        <option value="running">Running</option>
        <option value="completed">Completed</option>
      </select>
    </label>

    <label>
      Squad
      <input id="filter-squad" type="text" placeholder="e.g. finance" />
    </label>

    <label>
      Company ID
      <input id="filter-company" type="number" min="1" placeholder="e.g. 1" />
    </label>

    <button id="apply-filters">Apply filters</button>

    <span class="refresh-indicator" id="refreshIndicator">
      Auto-refresh: every 5s
    </span>
  </div>

  <div id="summary-strip" class="summary-strip">
    <span id="summary-total">0 tasks</span> ·
    <span id="summary-external">0 ✅ External</span> ·
    <span id="summary-fallback">0 ⚠️ Fallback</span>

    <button id="toggle-fallback" class="toggle-fallback-btn">
      Show only ⚠️ Fallback
    </button>
  </div>

  <table>
    <thead>
      <tr>
        <th style="width: 60px;">ID</th>
        <th>Title / Metadata</th>
        <th style="width: 180px;">Company / Squad</th>
        <th style="width: 120px;">Status</th>
        <th style="width: 140px;">Provider</th>
        <th style="width: 190px;">Created</th>
      </tr>
    </thead>
    <tbody id="tasksBody">
      <!-- Filled by JS -->
    </tbody>
  </table>

  <script>
let allTasks = [];
let showFallbackOnly = false;

function escapeHtml(str) {
  if (str === null || str === undefined) return "";
  return String(str)
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

async function fetchTasks() {
  try {
    const params = new URLSearchParams();

    const statusEl = document.getElementById("filter-status");
    const squadEl = document.getElementById("filter-squad");
    const companyEl = document.getElementById("filter-company");

    const status = statusEl ? statusEl.value : "";
    const squad = squadEl ? squadEl.value : "";
    const companyId = companyEl ? companyEl.value : "";

    if (status) params.append("status", status);
    if (squad) params.append("squad", squad);
    if (companyId) params.append("company_id", companyId);

    params.append("limit", "100");

    const res = await fetch(`/tasks?${params.toString()}`);
    const data = await res.json();

    allTasks = data.tasks || [];

    updateSummary(allTasks);
    renderTasks(getVisibleTasks());
  } catch (err) {
    console.error("Error fetching tasks:", err);
  }
}

function getVisibleTasks() {
  if (!showFallbackOnly) return allTasks;

  return allTasks.filter((task) => {
    const status = (task.external_provider_status || "").toLowerCase();
    return status.startsWith("fallback");
  });
}

function updateSummary(tasks) {
  const total = tasks.length;

  let externalCount = 0;
  let fallbackCount = 0;

  for (const t of tasks) {
    const st = (t.external_provider_status || "ok").toLowerCase();
    if (st === "ok" || st === "") {
      externalCount++;
    } else if (st.startsWith("fallback")) {
      fallbackCount++;
    }
  }
  const totalEl = document.getElementById("summary-total");
  const externalEl = document.getElementById("summary-external");
  const fallbackEl = document.getElementById("summary-fallback");

  if (totalEl) totalEl.textContent = `${total} task${total === 1 ? "" : "s"}`;
  if (externalEl) externalEl.textContent = `${externalCount} ✅ External`;
  if (fallbackEl) fallbackEl.textContent = `${fallbackCount} ⚠️ Fallback`;
}

function renderTasks(tasks) {
  const tbody = document.getElementById("tasksBody");
  if (!tbody) return;
  tbody.innerHTML = "";

  if (!tasks || tasks.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="6" style="text-align:center; padding: 12px;">
          No tasks found
        </td>
      </tr>
    `;
    return;
  }

  for (const task of tasks) {
    const row = document.createElement("tr");

    const created = task.created_at
      ? new Date(task.created_at).toLocaleString()
      : "";

    const status = task.status || "unknown";
    let badgeClass = "";
    if (status === "completed") badgeClass = "badge-completed";
    else if (status === "pending" || status === "in_progress") badgeClass = "badge-pending";
    else badgeClass = "badge-unknown";

    const metaParts = [];
    if (task.metadata_json) {
      for (const [key, value] of Object.entries(task.metadata_json)) {
        metaParts.push(`${key}: ${value}`);
      }
    }

    const metaText = metaParts.join(" · ");

    const providerStatus = (task.external_provider_status || "ok").toLowerCase();
    let providerCellHtml = "";
    if (providerStatus === "fallback_insufficient_quota") {
      providerCellHtml = `
        <span title="Fallback used due to insufficient quota">
          ⚠️ Fallback (quota)
        </span>
      `;
    } else if (providerStatus.startsWith("fallback")) {
      providerCellHtml = `
        <span title="Fallback used due to external error">
          ⚠️ Fallback
        </span>
      `;
    } else {
      providerCellHtml = `
        <span title="External AI provider OK">
          ✅ External
        </span>
      `;
    }


    row.innerHTML = `
      <td>#${escapeHtml(task.id)}</td>
      <td>
        <strong>${escapeHtml(task.title)}</strong>
        <div class="meta">${escapeHtml(metaText)}</div>
      </td>
      <td>
        ${task.company_id ? "Company " + escapeHtml(task.company_id) : "–"}
        ${task.squad ? " · Squad: " + escapeHtml(task.squad) : ""}
      </td>
      <td>
        <span class="badge ${badgeClass}">
          ${escapeHtml(status.toUpperCase())}
        </span>
      </td>
      <td>${providerCellHtml}</td>
      <td>${escapeHtml(created)}</td>
    `;

    tbody.appendChild(row);
  }
}

document.addEventListener("DOMContentLoaded", () => {
  const toggleBtn = document.getElementById("toggle-fallback");
  if (toggleBtn) {
    toggleBtn.addEventListener("click", () => {
      showFallbackOnly = !showFallbackOnly;
      toggleBtn.textContent = showFallbackOnly
        ? "Show all tasks"
        : "Show only ⚠️ Fallback";
      renderTasks(getVisibleTasks());
    });
  }

  const applyFiltersBtn = document.getElementById("apply-filters");
  if (applyFiltersBtn) {
    applyFiltersBtn.addEventListener("click", () => {
      fetchTasks();
    });
  }

  fetchTasks();
  setInterval(fetchTasks, 5000);
});
</script>
</body>
</html>

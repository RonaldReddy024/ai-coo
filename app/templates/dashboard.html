<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>WorkYodha AI COO – Sprint Risks</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      margin: 0;
      padding: 20px;
      background: #020617;
      color: #e5e7eb;
    }
    h1 { margin: 0 0 4px 0; }
    p.sub { margin: 0 0 16px 0; color: #9ca3af; font-size: 14px; }

    .layout-top {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 16px;
      flex-wrap: wrap;
    }
    .pill {
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 999px;
      background: #111827;
      color: #9ca3af;
    }

    .filters {
      margin-top: 16px;
      margin-bottom: 8px;
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
      font-size: 13px;
    }
    .filters label {
      display: flex;
      flex-direction: column;
      gap: 4px;
      color: #9ca3af;
      font-size: 12px;
    }
    .filters select,
    .filters input {
      background: #020617;
      border: 1px solid #1f2937;
      border-radius: 999px;
      padding: 6px 10px;
      color: #e5e7eb;
      font-size: 13px;
      outline: none;
    }
    .filters button {
      border-radius: 999px;
      border: none;
      padding: 7px 14px;
      font-size: 13px;
      cursor: pointer;
      background: #2563eb;
      color: #e5e7eb;
    }
    .filters button:hover {
      background: #1d4ed8;
    }

    .refresh-indicator {
      font-size: 12px;
      color: #6b7280;
      margin-left: auto;
    }

    .summary-strip {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
      font-size: 0.95rem;
    }

    .dashboard-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .new-task-btn {
      padding: 8px 14px;
      border-radius: 999px;
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: #022c22;
      text-decoration: none;
      font-size: 0.9rem;
      font-weight: 500;
      box-shadow: 0 10px 25px rgba(22, 163, 74, 0.5);
      cursor: pointer;
      transition: transform 0.08s ease, box-shadow 0.08s ease;
    }

    .new-task-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 30px rgba(22, 163, 74, 0.7);
    }

    .summary-strip span {
      white-space: nowrap;
    }

    .toggle-fallback-btn {
      margin-left: auto;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid #ddd;
      background: #f8f8f8;
      cursor: pointer;
      font-size: 0.85rem;
    }

    .toggle-fallback-btn:hover {
      background: #eee;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
      font-size: 13px;
    }
    th, td {
      padding: 8px 10px;
      border-bottom: 1px solid #111827;
      text-align: left;
      vertical-align: top;
    }
    th {
      background: #020617;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    .task-link {
      color: inherit;
      text-decoration: none;
      cursor: pointer;
    }

    .task-link:hover {
      text-decoration: underline;
    }

    .badge {
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }
    .status-completed { background: #16a34a22; color: #4ade80; }
    .status-pending   { background: #fbbf2422; color: #facc15; }
    .status-running   { background: #38bdf822; color: #7dd3fc; }

    .meta {
      color: #9ca3af;
      font-size: 12px;
      margin-top: 2px;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .status-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      display: inline-block;
      margin-right: 4px;
      background: #4ade80;
    }

    .grid-two {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 16px;
      align-items: start;
    }

    @media (max-width: 980px) {
      .grid-two {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: #0b1220;
      border: 1px solid #1f2937;
      border-radius: 12px;
      padding: 14px 16px;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.25);
    }

    .card h3 {
      margin: 0 0 8px 0;
      font-size: 15px;
    }

    .muted {
      color: #9ca3af;
      font-size: 13px;
    }

    .pill-info {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 3px 8px;
      border-radius: 999px;
      background: #111827;
      color: #e5e7eb;
      font-size: 11px;
    }

    .selected-row {
      background: #0b1220;
    }
  </style>
</head>
<body>
  <div class="dashboard-header">
    <h1>WorkYodha – Sprint Risks</h1>
    <a href="/tasks/new" class="new-task-btn">+ New Task</a>
  </div>

  <div class="layout-top">
    <div>
      <p class="sub">
        Live view of tasks your AI COO is processing in rupees (₹).
      </p>
      {% if user_email %}
      <p class="sub">
        Signed in as {{ user_email }}
      </p>
      {% endif %}
    </div>
    <div>
      <span class="pill">
        <span class="status-dot"></span>
        Backend: healthy
      </span>
    </div>
  </div>

  <div class="filters">
    <label>
      Status
      <select id="filter-status">
        <option value="">All</option>
        <option value="pending">Pending</option>
        <option value="running">Running</option>
        <option value="completed">Completed</option>
      </select>
    </label>

    <label>
      Squad
      <input id="filter-squad" type="text" placeholder="e.g. finance" />
    </label>

    <label>
      Company ID
      <input id="filter-company" type="number" min="1" placeholder="e.g. 1" />
    </label>

    <button id="apply-filters">Apply filters</button>

    <span class="refresh-indicator" id="refreshIndicator">
      Auto-refresh: every 5s
    </span>
  </div>

  <div id="summary-strip" class="summary-strip">
    <span id="summary-total">0 tasks</span> ·
    <span id="summary-external">0 ✅ External</span> ·
    <span id="summary-fallback">0 ⚠️ Fallback</span>

    <button id="toggle-fallback" class="toggle-fallback-btn">
      Show only ⚠️ Fallback
    </button>
  </div>

  <div class="grid-two">
    <div class="card">
      <table>
        <thead>
          <tr>
            <th style="width: 60px;">ID</th>
            <th>Title / Metadata</th>
            <th style="width: 180px;">Company / Squad</th>
            <th style="width: 120px;">Status</th>
            <th style="width: 140px;">Provider</th>
            <th style="width: 190px;">Created</th>
          </tr>
        </thead>
        <tbody id="tasksBody">
          <!-- Filled by JS -->
        </tbody>
      </table>
    </div>

    <div class="card" id="taskDetailCard">
      <h3 id="detailTitle">Select a task</h3>
      <p class="muted" id="detailStatus">Click a task on the left to see next steps and dependencies.</p>

      <div id="detailMeta" class="muted" style="margin-bottom: 10px;"></div>

      <div style="margin-bottom: 12px;">
        <div class="pill-info" id="detailNextStepsLabel">Next steps</div>
        <pre id="detailNextSteps" style="white-space: pre-wrap; background:#020617; padding:10px; border-radius:10px; border:1px solid #1f2937; color:#e5e7eb;">No task selected.</pre>
      </div>

      <div style="margin-bottom: 10px;">
        <div class="pill-info">Tasks that should be completed first</div>
        <ul id="detailDepends" class="muted"></ul>
      </div>

      <div>
        <div class="pill-info">Tasks that cannot be completed until this is done</div>
        <ul id="detailBlocks" class="muted"></ul>
      </div>
    </div>
  </div>

  <script>
let allTasks = [];
let showFallbackOnly = false;
let selectedTaskId = null;
    
function escapeHtml(str) {
  if (str === null || str === undefined) return "";
  return String(str)
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

async function fetchTasks() {
  try {
    const params = new URLSearchParams();

    const statusEl = document.getElementById("filter-status");
    const squadEl = document.getElementById("filter-squad");
    const companyEl = document.getElementById("filter-company");

    const status = statusEl ? statusEl.value : "";
    const squad = squadEl ? squadEl.value : "";
    const companyId = companyEl ? companyEl.value : "";

    if (status) params.append("status", status);
    if (squad) params.append("squad", squad);
    if (companyId) params.append("company_id", companyId);

    params.append("limit", "100");

    const res = await fetch(`/tasks?${params.toString()}`);
    const data = await res.json();

    allTasks = data.tasks || [];

    updateSummary(allTasks);
    renderTasks(getVisibleTasks());
  } catch (err) {
    console.error("Error fetching tasks:", err);
  }
}

function getVisibleTasks() {
  if (!showFallbackOnly) return allTasks;

  return allTasks.filter((task) => {
    const status = (task.external_provider_status || "").toLowerCase();
    return status.startsWith("fallback");
  });
}

function updateSummary(tasks) {
  const total = tasks.length;

  let externalCount = 0;
  let fallbackCount = 0;

  for (const t of tasks) {
    const st = (t.external_provider_status || "ok").toLowerCase();
    if (st === "ok" || st === "") {
      externalCount++;
    } else if (st.startsWith("fallback")) {
      fallbackCount++;
    }
  }
  const totalEl = document.getElementById("summary-total");
  const externalEl = document.getElementById("summary-external");
  const fallbackEl = document.getElementById("summary-fallback");

  if (totalEl) totalEl.textContent = `${total} task${total === 1 ? "" : "s"}`;
  if (externalEl) externalEl.textContent = `${externalCount} ✅ External`;
  if (fallbackEl) fallbackEl.textContent = `${fallbackCount} ⚠️ Fallback`;
}

function renderTasks(tasks) {
  const tbody = document.getElementById("tasksBody");
  if (!tbody) return;
  tbody.innerHTML = "";

  if (!tasks || tasks.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="6" style="text-align:center; padding: 12px;">
          No tasks found
        </td>
      </tr>
    `;
    return;
  }

  for (const task of tasks) {
    const row = document.createElement("tr");
    row.dataset.taskId = task.id;
    row.addEventListener("click", () => {
      selectedTaskId = task.id;
      highlightSelectedRow();
      loadTaskSummary(task.id);
    });
    
    const created = task.created_at
      ? new Date(task.created_at).toLocaleString()
      : "";

    const status = task.status || "unknown";
    let badgeClass = "";
    if (status === "completed") badgeClass = "badge-completed";
    else if (status === "pending" || status === "in_progress") badgeClass = "badge-pending";
    else badgeClass = "badge-unknown";

    const metaParts = [];
    if (task.metadata_json) {
      for (const [key, value] of Object.entries(task.metadata_json)) {
        metaParts.push(`${key}: ${value}`);
      }
    }

    const metaText = metaParts.join(" · ");

    const providerStatus = (task.external_provider_status || "ok").toLowerCase();
    let providerCellHtml = "";
    if (providerStatus === "fallback_insufficient_quota") {
      providerCellHtml = `
        <span title="Fallback used due to insufficient quota">
          ⚠️ Fallback (quota)
        </span>
      `;
    } else if (providerStatus.startsWith("fallback")) {
      providerCellHtml = `
        <span title="Fallback used due to external error">
          ⚠️ Fallback
        </span>
      `;
    } else {
      providerCellHtml = `
        <span title="External AI provider OK">
          ✅ External
        </span>
      `;
    }


    row.innerHTML = `
      <td>#${escapeHtml(task.id)}</td>
      <td>
        <a href="/tasks/${encodeURIComponent(task.id)}/view" class="task-link">
          <strong>${escapeHtml(task.title)}</strong>
        </a>
        <div class="meta">${escapeHtml(metaText)}</div>
      </td>
      <td>
        ${task.company_id ? "Company " + escapeHtml(task.company_id) : "–"}
        ${task.squad ? " · Squad: " + escapeHtml(task.squad) : ""}
      </td>
      <td>
        <span class="badge ${badgeClass}">
          ${escapeHtml(status.toUpperCase())}
        </span>
      </td>
      <td>${providerCellHtml}</td>
      <td>${escapeHtml(created)}</td>
    `;

    tbody.appendChild(row);
  }

  if (selectedTaskId && tasks.some((t) => t.id === selectedTaskId)) {
    highlightSelectedRow();
  } else if (tasks.length > 0) {
    selectedTaskId = tasks[0].id;
    highlightSelectedRow();
    loadTaskSummary(selectedTaskId);
  }
}

function highlightSelectedRow() {
  const rows = document.querySelectorAll("#tasksBody tr");
  rows.forEach((row) => {
    if (Number(row.dataset.taskId) === Number(selectedTaskId)) {
      row.classList.add("selected-row");
    } else {
      row.classList.remove("selected-row");
    }
  });
}

async function loadTaskSummary(taskId) {
  try {
    const res = await fetch(`/tasks/${taskId}/summary`);
    if (!res.ok) {
      throw new Error(`Failed to load summary (HTTP ${res.status})`);
    }
    const data = await res.json();
    renderTaskSummary(data);
  } catch (err) {
    const detailTitle = document.getElementById("detailTitle");
    const detailStatus = document.getElementById("detailStatus");
    if (detailTitle) detailTitle.textContent = "Unable to load task";
    if (detailStatus) detailStatus.textContent = err.message;
  }
}

function renderTaskSummary(summary) {
  const { task, next_steps, depends_on, blocks } = summary;
  const titleEl = document.getElementById("detailTitle");
  const statusEl = document.getElementById("detailStatus");
  const nextEl = document.getElementById("detailNextSteps");
  const metaEl = document.getElementById("detailMeta");
  const dependsEl = document.getElementById("detailDepends");
  const blocksEl = document.getElementById("detailBlocks");

  if (titleEl) titleEl.textContent = `#${task.id} · ${task.title}`;
  if (statusEl)
    statusEl.textContent = `Status: ${task.status.toUpperCase()} · Provider: ${
      task.external_provider_status || "ok"
    }`;
  if (nextEl) nextEl.textContent = next_steps || "No next steps defined yet.";

  if (metaEl) {
    const metaParts = [];
    if (task.company_id) metaParts.push(`Company ${task.company_id}`);
    if (task.squad) metaParts.push(`Squad ${task.squad}`);
    const md = task.metadata_json || {};
    const metaKeys = Object.keys(md);
    for (const key of metaKeys.slice(0, 3)) {
      metaParts.push(`${key}: ${md[key]}`);
    }
    metaEl.textContent = metaParts.length ? metaParts.join(" · ") : "No metadata";
  }

  if (dependsEl) {
    dependsEl.innerHTML = "";
    if (!depends_on || depends_on.length === 0) {
      dependsEl.innerHTML = "<li>No prerequisites detected.</li>";
    } else {
      for (const t of depends_on) {
        const li = document.createElement("li");
        li.textContent = `#${t.id} – ${t.title} [${t.status}]`;
        dependsEl.appendChild(li);
      }
    }
  }

  if (blocksEl) {
    blocksEl.innerHTML = "";
    if (!blocks || blocks.length === 0) {
      blocksEl.innerHTML = "<li>No downstream blockers.</li>";
    } else {
      for (const t of blocks) {
        const li = document.createElement("li");
        li.textContent = `#${t.id} – ${t.title} [${t.status}]`;
        blocksEl.appendChild(li);
      }
    }
  }
}

document.addEventListener("DOMContentLoaded", () => {
  const toggleBtn = document.getElementById("toggle-fallback");
  if (toggleBtn) {
    toggleBtn.addEventListener("click", () => {
      showFallbackOnly = !showFallbackOnly;
      toggleBtn.textContent = showFallbackOnly
        ? "Show all tasks"
        : "Show only ⚠️ Fallback";
      renderTasks(getVisibleTasks());
    });
  }

  const applyFiltersBtn = document.getElementById("apply-filters");
  if (applyFiltersBtn) {
    applyFiltersBtn.addEventListener("click", () => {
      fetchTasks();
    });
  }

  fetchTasks();
  setInterval(fetchTasks, 5000);
});
</script>
</body>
</html>
